AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Xcalar Cluster Serverless Application\nSAM Template for sam-cluster\n
Globals:
  Function:
    Timeout: 300
  Api:
    Cors:
      AllowMethods: "'OPTIONS,POST,GET'"
      AllowHeaders: "'Content-Type'"
      AllowOrigin: "'*'"

Resources:
  LibLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: sam-saas-lib
      Description: A set of code shared across functions within sam-saas
      ContentUri: lib/
      CompatibleRuntimes:
        - python3.6
  ClusterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/cluster
      Handler: cluster.lambda_handler
      Runtime: python3.6
      Layers:
        - !Ref LibLayer
      Events:
        StartCluster:
          Type: Api
          Properties:
            Path: /cluster/start
            Method: post
        StopCluster:
          Type: Api
          Properties:
            Path: /cluster/stop
            Method: post
        GetClusterUrl:
          Type: Api
          Properties:
            Path: /cluster/get
            Method: post
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cloudformation:UpdateStack
              Resource:
                !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/saas-test-*'
            - Effect: Allow
              Action:
                - cloudformation:DescribeStacks
              Resource: '*'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource:
                !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/saas_user'
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource:
                !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/saas_billing'
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource:
                !Sub 'arn:aws:iam::${AWS::AccountId}:role/AWSCloudFormationAdmin'
            - Effect: Allow
              Action:
                - ec2:DescribeInstances
              Resource: '*'
  BillingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/billing
      Handler: billing.lambda_handler
      Runtime: python3.6
      Layers:
        - !Ref LibLayer
      Events:
        GetCredit:
          Type: Api
          Properties:
            Path: /billing/get
            Method: post
        UpdateCredit:
          Type: Api
          Properties:
            Path: /billing/update
            Method: post
        DeductCredit:
          Type: Api
          Properties:
            Path: /billing/deduct
            Method: post
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cloudformation:DescribeStacks
              Resource: '*'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/saas_user'
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:Query
              Resource:
                !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/saas_billing'
  S3Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/s3/
      Handler: s3.lambda_handler
      Runtime: python3.6
      Layers:
        - !Ref LibLayer
      Events:
        UploadFile:
          Type: Api
          Properties:
            Path: /s3/upload
            Method: post
        BucketInfo:
          Type: Api
          Properties:
            Path: /s3/describe
            Method: post
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cloudformation:DescribeStacks
              Resource: '*'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/saas_user'
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource:
                !Sub 'arn:aws:s3:::saas-test*' # For test only


Outputs:
  SaaSApi:
    Description: API Gateway endpoint URL for Prod stage for SaaS function
    Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/v1/'
  ClusterFunction:
    Description: Cluster Lambda Function ARN
    Value: !GetAtt 'ClusterFunction.Arn'
  ClusterFunctionIamRole:
    Description: Implicit IAM Role created for Cluster function
    Value: !GetAtt 'ClusterFunctionRole.Arn'
  BillingFunction:
    Description: Billing Lambda Function ARN
    Value: !GetAtt 'BillingFunction.Arn'
  BillingFunctionIamRole:
    Description: Implicit IAM Role created for Billing function
    Value: !GetAtt 'BillingFunctionRole.Arn'
  S3Function:
    Description: S3 Lambda Function ARN
    Value: !GetAtt 'S3Function.Arn'
  S3FunctionIamRole:
    Description: Implicit IAM Role created for S3 function
    Value: !GetAtt 'S3FunctionRole.Arn'

