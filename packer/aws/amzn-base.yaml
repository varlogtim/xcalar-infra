---
variables:
  uid: '1000'
  disk_size: '8'
  device_name: /dev/xvda
  baseos: 'amzn-ami'
  baseos_owner: '137112412989'
  aws_access_key: '{{env `AWS_ACCESS_KEY_ID`}}'
  aws_secret_key: '{{env `AWS_SECRET_ACCESS_KEY`}}'
  region: '{{env `AWS_DEFAULT_REGION`}}'
  destination_regions: 'us-east-1,us-west-2'
  today: '{{isotime "20060102"}}'
  image_build_number: '1'
  product: xdp-base
  product_desc: Xcalar Base Image
  description: Xcalar Base Image
  build_number: '{{env `BUILD_NUMBER`}}'
  ssh_username: ec2-user
  shared_with: '045297022527,043829555035,364047378361,876030232190'
builders:
  - type: amazon-ebs
    name: amazon-ebs-amzn1
    access_key: '{{user `aws_access_key`}}'
    secret_key: '{{user `aws_secret_key`}}'
    ssh_keypair_name: 'packer'
    ssh_private_key_file: '{{template_dir}}/../ssh/id_packer.pem'
    region: '{{user `region`}}'
    ami_regions: '{{user `destination_regions`}}'
    ami_users: '{{user `shared_with`}}'
    source_ami_filter:
      filters:
        virtualization-type: hvm
        architecture: 'x86_64'
        root-device-type: ebs
        block-device-mapping.volume-type: gp2
        name: '{{user `baseos`}}*'
      owners: '{{user `baseos_owner`}}'
      most_recent: true
    instance_type: c5d.xlarge
    iam_instance_profile: ec2-default
    ssh_username: '{{user `ssh_username`}}'
    ssh_pty: true
    ena_support: true
    ebs_optimized: true
    force_deregister: true
    force_delete_snapshot: true
    shutdown_behavior: terminate
    ami_name: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
    ami_description: 'Xcalar AmazonLinux Base Image ({{user `today`}}-{{user `build_number`}})'
    run_tags:
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{split .SourceAMIName "-" 3}}-{{user `today`}}-{{user `build_number`}}'
    snapshot_tags:
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
      BaseAMI: '{{.SourceAMI}}'
      BaseOS: '{{.SourceAMIName}}'
      OSID: '{{split build_name "-" 2}}'
      Version: '{{split .SourceAMIName "-" 3}}'
      Build: '{{user `build_number`}}'
      Today: '{{user `today`}}'
      Product: '{{user `product`}}'
    tags:
      AMIName: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{split .SourceAMIName "-" 3}}-{{user `today`}}-{{user `build_number`}}'
      BaseAMI: '{{.SourceAMI}}'
      BaseOS: '{{.SourceAMIName}}'
      OSID: '{{split build_name "-" 2}}'
      Version: '{{split .SourceAMIName "-" 3}}'
      Build: '{{user `build_number`}}'
      Today: '{{user `today`}}'
      Product: '{{user `product`}}'
    launch_block_device_mappings:
      - device_name: '{{user `device_name`}}'
        volume_size: '{{user `disk_size`}}'
        volume_type: gp2
        delete_on_termination: true
    ami_block_device_mappings:
      - device_name: /dev/sdb
        virtual_name: ephemeral0
      - device_name: /dev/sdc
        virtual_name: ephemeral1
  - type: amazon-ebs
    name: amazon-ebs-amzn2
    access_key: '{{user `aws_access_key`}}'
    secret_key: '{{user `aws_secret_key`}}'
    ssh_keypair_name: 'packer'
    ssh_private_key_file: '{{template_dir}}/../ssh/id_packer.pem'
    region: '{{user `region`}}'
    ami_regions: '{{user `destination_regions`}}'
    ami_users: '{{user `shared_with`}}'
    source_ami_filter:
      filters:
        virtualization-type: hvm
        architecture: 'x86_64'
        root-device-type: ebs
        block-device-mapping.volume-type: gp2
        name: '{{user `baseos`}}*'
      owners: '{{user `baseos_owner`}}'
      most_recent: true
    instance_type: c5d.xlarge
    iam_instance_profile: ec2-default
    ssh_username: '{{user `ssh_username`}}'
    ssh_pty: true
    ena_support: true
    ebs_optimized: true
    force_deregister: true
    force_delete_snapshot: true
    shutdown_behavior: terminate
    ami_name: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
    ami_description: 'Xcalar AmazonLinux Base Image ({{user `today`}}-{{user `build_number`}})'
    run_tags:
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{split .SourceAMIName "-" 3}}-{{user `today`}}-{{user `build_number`}}'
    snapshot_tags:
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
      BaseAMI: '{{.SourceAMI}}'
      BaseOS: '{{.SourceAMIName}}'
      OSID: '{{split build_name "-" 2}}'
      Version: '{{split .SourceAMIName "-" 3}}'
      Build: '{{user `build_number`}}'
      Today: '{{user `today`}}'
      Product: '{{user `product`}}'
    tags:
      AMIName: '{{user `product`}}-{{split build_name "-" 2}}-{{user `today`}}-{{user `build_number`}}'
      Name: '{{user `product`}}-{{split build_name "-" 2}}-{{split .SourceAMIName "-" 3}}-{{user `today`}}-{{user `build_number`}}'
      BaseAMI: '{{.SourceAMI}}'
      BaseOS: '{{.SourceAMIName}}'
      OSID: '{{split build_name "-" 2}}'
      Version: '{{split .SourceAMIName "-" 3}}'
      Build: '{{user `build_number`}}'
      Today: '{{user `today`}}'
      Product: '{{user `product`}}'
    launch_block_device_mappings:
      - device_name: '{{user `device_name`}}'
        volume_size: '{{user `disk_size`}}'
        volume_type: gp2
        delete_on_termination: true
    ami_block_device_mappings:
      - device_name: /dev/sdb
        virtual_name: ephemeral0
      - device_name: /dev/sdc
        virtual_name: ephemeral1
provisioners:
  - type: shell
    environment_vars:
      - OSID={{split build_name "-" 2}}
    execute_command: '{{.Vars}} /usr/bin/sudo -H -E bash ''{{.Path}}'''
    scripts:
      - '{{ template_dir }}/../scripts/start.sh'
      - '{{ template_dir }}/../scripts/install-epel.sh'
      - '{{ template_dir }}/../scripts/install-java8.sh'
      - '{{ template_dir }}/../scripts/packages-amzn.sh'
  - type: file
    source: '{{ template_dir }}/../scripts/aws-verify.sh'
    destination: /tmp/aws-verify.sh
  - type: shell
    execute_command: '{{.Vars}} /usr/bin/sudo -H -E bash ''{{.Path}}'''
    inline:
      - chmod 0755 /tmp/aws-verify.sh
      - chown root:root /tmp/aws-verify.sh
      - mv /tmp/aws-verify.sh /usr/bin/
  - type: shell
    environment_vars:
      - OSID={{split build_name "-" 2}}
    execute_command: '{{.Vars}} /usr/bin/sudo -H -E bash ''{{.Path}}'''
    scripts:
      - '{{ template_dir }}/../scripts/finish.sh'
