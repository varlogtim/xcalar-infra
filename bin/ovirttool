#!/bin/bash

set -e

if [ -z "$XLRINFRADIR" ]; then
  echo >&2 "Must set XLRINFRADIR"
  exit 1
fi

cd $XLRINFRADIR

if ! docker image inspect ovirttool >/dev/null 2>&1; then
    TMP=$(mktemp -d -t ovirtool.XXXXXX)
    docker build -t ovirttool -f $XLRINFRADIR/docker/ovirttool.df $TMP
fi
cd $XLRINFRADIR

# OVIRT_PASSWORD and OVIRT_UNAME set in shell wrapper; allows tool to be non-interactive
# (--user in @$ takes precedence over OVIRT_UNAME if both supplied)
docker run -t -e OVIRT_PASSWORD -e OVIRT_UNAME -v /netstore:/netstore -v $XLRINFRADIR:$XLRINFRADIR -w $XLRINFRADIR -u `id -u`:`id -g` --rm ovirttool ovirt/ovirttool.py "$@"
